{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.6.1.6515",
      "templateHash": "5060308219023951068"
    }
  },
  "parameters": {
    "Prefix": {
      "type": "string",
      "defaultValue": "AVS",
      "maxLength": 20,
      "minLength": 1,
      "metadata": {
        "description": "The prefix to use on resources inside this template"
      }
    },
    "Location": {
      "type": "string",
      "defaultValue": "[deployment().location]",
      "metadata": {
        "description": "Optional: The location the private cloud should be deployed to, by default this will be the location of the deployment"
      }
    },
    "PrivateCloudAddressSpace": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The address space used for the AVS Private Cloud management networks. Must be a non-overlapping /22"
      }
    },
    "PrivateCloudSKU": {
      "type": "string",
      "defaultValue": "AV36",
      "allowedValues": [
        "AV36",
        "AV36T"
      ],
      "metadata": {
        "description": "The SKU that should be used for the first cluster, ensure you have quota for the given SKU before deploying"
      }
    },
    "PrivateCloudHostCount": {
      "type": "int",
      "defaultValue": 3,
      "metadata": {
        "description": "The number of nodes to be deployed in the first/default cluster, ensure you have quota before deploying"
      }
    },
    "VNetExists": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Set this to true if you are redeploying, and the VNet already exists"
      }
    },
    "VNetAddressSpace": {
      "type": "string",
      "metadata": {
        "description": "The address space used for the VNet attached to AVS. Must be non-overlapping with existing networks"
      }
    },
    "VNetGatewaySubnet": {
      "type": "string",
      "metadata": {
        "description": "The subnet CIDR used for the Gateway Subnet. Must be a /24 or greater within the VNetAddressSpace"
      }
    },
    "DeployJumpbox": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Should a Jumpbox & Bastion be deployed to access the Private Cloud"
      }
    },
    "JumpboxUsername": {
      "type": "string",
      "defaultValue": "avsjump",
      "metadata": {
        "description": "Username for the Jumpbox VM"
      }
    },
    "JumpboxPassword": {
      "type": "secureString",
      "defaultValue": "",
      "metadata": {
        "description": "Password for the Jumpbox VM, can be changed later"
      }
    },
    "JumpboxSubnet": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The subnet CIDR used for the Jumpbox VM Subnet. Must be a /26 or greater within the VNetAddressSpace"
      }
    },
    "JumpboxSku": {
      "type": "string",
      "defaultValue": "Standard_D2s_v3",
      "metadata": {
        "description": "The sku to use for the Jumpbox VM, must have quota for this within the target region"
      }
    },
    "BastionSubnet": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The subnet CIDR used for the Bastion Subnet. Must be a /26 or greater within the VNetAddressSpace"
      }
    },
    "DeployHCX": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Should HCX be deployed as part of the deployment"
      }
    },
    "DeploySRM": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Should SRM be deployed as part of the deployment"
      }
    },
    "SRMLicenseKey": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "License key to be used if SRM is deployed"
      }
    },
    "VRServerCount": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "Number of vSphere Replication Servers to be created if SRM is deployed"
      },
      "maxValue": 10,
      "minValue": 1
    },
    "TelemetryOptOut": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Opt-out of deployment telemetry"
      }
    },
    "DeployPrivateCloud": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Set this to false if the Private Cloud already exists"
      }
    }
  },
  "variables": {
    "deploymentPrefix": "[format('AVS-{0}', uniqueString(deployment().name, parameters('Location')))]"
  },
  "resources": [
    {
      "condition": "[parameters('DeployPrivateCloud')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-AVS', variables('deploymentPrefix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "Prefix": {
            "value": "[parameters('Prefix')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "PrivateCloudAddressSpace": {
            "value": "[parameters('PrivateCloudAddressSpace')]"
          },
          "PrivateCloudHostCount": {
            "value": "[parameters('PrivateCloudHostCount')]"
          },
          "PrivateCloudSKU": {
            "value": "[parameters('PrivateCloudSKU')]"
          },
          "TelemetryOptOut": {
            "value": "[parameters('TelemetryOptOut')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.6.1.6515",
              "templateHash": "1437360065014760585"
            }
          },
          "parameters": {
            "Location": {
              "type": "string"
            },
            "Prefix": {
              "type": "string"
            },
            "PrivateCloudAddressSpace": {
              "type": "string"
            },
            "PrivateCloudSKU": {
              "type": "string"
            },
            "PrivateCloudHostCount": {
              "type": "int"
            },
            "TelemetryOptOut": {
              "type": "bool"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[format('{0}-PrivateCloud', parameters('Prefix'))]",
              "location": "[parameters('Location')]"
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('{0}-PrivateCloud', deployment().name)]",
              "resourceGroup": "[format('{0}-PrivateCloud', parameters('Prefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Prefix": {
                    "value": "[parameters('Prefix')]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "NetworkBlock": {
                    "value": "[parameters('PrivateCloudAddressSpace')]"
                  },
                  "SKUName": {
                    "value": "[parameters('PrivateCloudSKU')]"
                  },
                  "ManagementClusterSize": {
                    "value": "[parameters('PrivateCloudHostCount')]"
                  },
                  "TelemetryOptOut": {
                    "value": "[parameters('TelemetryOptOut')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.6.1.6515",
                      "templateHash": "12902886049727200271"
                    }
                  },
                  "parameters": {
                    "Prefix": {
                      "type": "string"
                    },
                    "NetworkBlock": {
                      "type": "string"
                    },
                    "ManagementClusterSize": {
                      "type": "int"
                    },
                    "SKUName": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "TelemetryOptOut": {
                      "type": "bool"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.AVS/privateClouds",
                      "apiVersion": "2021-06-01",
                      "name": "[format('{0}-SDDC', parameters('Prefix'))]",
                      "sku": {
                        "name": "[parameters('SKUName')]"
                      },
                      "location": "[parameters('Location')]",
                      "properties": {
                        "networkBlock": "[parameters('NetworkBlock')]",
                        "managementCluster": {
                          "clusterSize": "[parameters('ManagementClusterSize')]"
                        }
                      }
                    },
                    {
                      "condition": "[not(parameters('TelemetryOptOut'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2021-04-01",
                      "name": "pid-754599a0-0a6f-424a-b4c5-1b12be198ae8",
                      "properties": {
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "resources": []
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "PrivateCloudName": {
                      "type": "string",
                      "value": "[format('{0}-SDDC', parameters('Prefix'))]"
                    },
                    "PrivateCloudResourceId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.AVS/privateClouds', format('{0}-SDDC', parameters('Prefix')))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-PrivateCloud', parameters('Prefix')))]"
              ]
            }
          ],
          "outputs": {
            "PrivateCloudName": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-PrivateCloud', parameters('Prefix'))), 'Microsoft.Resources/deployments', format('{0}-PrivateCloud', deployment().name))).outputs.PrivateCloudName.value]"
            },
            "PrivateCloudResourceGroupName": {
              "type": "string",
              "value": "[format('{0}-PrivateCloud', parameters('Prefix'))]"
            },
            "PrivateCloudResourceId": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-PrivateCloud', parameters('Prefix'))), 'Microsoft.Resources/deployments', format('{0}-PrivateCloud', deployment().name))).outputs.PrivateCloudResourceId.value]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-Network', variables('deploymentPrefix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "Prefix": {
            "value": "[parameters('Prefix')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "VNetExists": {
            "value": "[parameters('VNetExists')]"
          },
          "VNetAddressSpace": {
            "value": "[parameters('VNetAddressSpace')]"
          },
          "VNetGatewaySubnet": {
            "value": "[parameters('VNetGatewaySubnet')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.6.1.6515",
              "templateHash": "1891369300678807274"
            }
          },
          "parameters": {
            "Location": {
              "type": "string"
            },
            "Prefix": {
              "type": "string"
            },
            "VNetExists": {
              "type": "bool"
            },
            "VNetAddressSpace": {
              "type": "string"
            },
            "VNetGatewaySubnet": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[format('{0}-Network', parameters('Prefix'))]",
              "location": "[parameters('Location')]"
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('{0}-Network', deployment().name)]",
              "resourceGroup": "[format('{0}-Network', parameters('Prefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Prefix": {
                    "value": "[parameters('Prefix')]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "VNetExists": {
                    "value": "[parameters('VNetExists')]"
                  },
                  "VNetAddressSpace": {
                    "value": "[parameters('VNetAddressSpace')]"
                  },
                  "VNetGatewaySubnet": {
                    "value": "[parameters('VNetGatewaySubnet')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.6.1.6515",
                      "templateHash": "15913851186141939538"
                    }
                  },
                  "parameters": {
                    "Location": {
                      "type": "string"
                    },
                    "Prefix": {
                      "type": "string"
                    },
                    "VNetExists": {
                      "type": "bool"
                    },
                    "VNetAddressSpace": {
                      "type": "string"
                    },
                    "VNetGatewaySubnet": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "GatewayName": "[format('{0}-GW', parameters('Prefix'))]",
                    "VNetName": "[format('{0}-VNet', parameters('Prefix'))]"
                  },
                  "resources": [
                    {
                      "condition": "[not(parameters('VNetExists'))]",
                      "type": "Microsoft.Network/virtualNetworks",
                      "apiVersion": "2021-02-01",
                      "name": "[variables('VNetName')]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "addressSpace": {
                          "addressPrefixes": [
                            "[parameters('VNetAddressSpace')]"
                          ]
                        }
                      }
                    },
                    {
                      "condition": "[not(parameters('VNetExists'))]",
                      "type": "Microsoft.Network/virtualNetworks/subnets",
                      "apiVersion": "2021-02-01",
                      "name": "[format('{0}/{1}', variables('VNetName'), 'GatewaySubnet')]",
                      "properties": {
                        "addressPrefix": "[parameters('VNetGatewaySubnet')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/virtualNetworks', variables('VNetName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "VNetName": {
                      "type": "string",
                      "value": "[if(parameters('VNetExists'), variables('VNetName'), variables('VNetName'))]"
                    },
                    "VNetResourceId": {
                      "type": "string",
                      "value": "[if(parameters('VNetExists'), resourceId('Microsoft.Network/virtualNetworks', variables('VNetName')), resourceId('Microsoft.Network/virtualNetworks', variables('VNetName')))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-Network', parameters('Prefix')))]"
              ]
            }
          ],
          "outputs": {
            "VNetName": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-Network', parameters('Prefix'))), 'Microsoft.Resources/deployments', format('{0}-Network', deployment().name))).outputs.VNetName.value]"
            },
            "VNetResourceId": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-Network', parameters('Prefix'))), 'Microsoft.Resources/deployments', format('{0}-Network', deployment().name))).outputs.VNetResourceId.value]"
            },
            "NetworkResourceGroup": {
              "type": "string",
              "value": "[format('{0}-Network', parameters('Prefix'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-AVSAddons', variables('deploymentPrefix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "PrivateCloudName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('{0}-AVS', variables('deploymentPrefix'))), '2020-10-01').outputs.PrivateCloudName.value]"
          },
          "PrivateCloudResourceGroup": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('{0}-AVS', variables('deploymentPrefix'))), '2020-10-01').outputs.PrivateCloudResourceGroupName.value]"
          },
          "DeployHCX": {
            "value": "[parameters('DeployHCX')]"
          },
          "DeploySRM": {
            "value": "[parameters('DeploySRM')]"
          },
          "SRMLicenseKey": {
            "value": "[parameters('SRMLicenseKey')]"
          },
          "VRServerCount": {
            "value": "[parameters('VRServerCount')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.6.1.6515",
              "templateHash": "12779609323418793545"
            }
          },
          "parameters": {
            "PrivateCloudName": {
              "type": "string"
            },
            "PrivateCloudResourceGroup": {
              "type": "string"
            },
            "DeployHCX": {
              "type": "bool"
            },
            "DeploySRM": {
              "type": "bool"
            },
            "SRMLicenseKey": {
              "type": "string"
            },
            "VRServerCount": {
              "type": "int",
              "maxValue": 10,
              "minValue": 1
            }
          },
          "resources": [
            {
              "condition": "[parameters('DeployHCX')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('{0}-HCX', deployment().name)]",
              "resourceGroup": "[parameters('PrivateCloudResourceGroup')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "PrivateCloudName": {
                    "value": "[parameters('PrivateCloudName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.6.1.6515",
                      "templateHash": "7598206471339695858"
                    }
                  },
                  "parameters": {
                    "PrivateCloudName": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.AVS/privateClouds/addons",
                      "apiVersion": "2021-06-01",
                      "name": "[format('{0}/{1}', parameters('PrivateCloudName'), 'hcx')]",
                      "properties": {
                        "addonType": "HCX",
                        "offer": "VMware MaaS Cloud Provider"
                      }
                    }
                  ]
                }
              }
            },
            {
              "condition": "[parameters('DeploySRM')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('{0}-SRM', deployment().name)]",
              "resourceGroup": "[parameters('PrivateCloudResourceGroup')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "PrivateCloudName": {
                    "value": "[parameters('PrivateCloudName')]"
                  },
                  "SRMLicenseKey": {
                    "value": "[parameters('SRMLicenseKey')]"
                  },
                  "VRServerCount": {
                    "value": "[parameters('VRServerCount')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.6.1.6515",
                      "templateHash": "3474639844399078169"
                    }
                  },
                  "parameters": {
                    "PrivateCloudName": {
                      "type": "string"
                    },
                    "SRMLicenseKey": {
                      "type": "string"
                    },
                    "VRServerCount": {
                      "type": "int",
                      "maxValue": 10,
                      "minValue": 1
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.AVS/privateClouds/addons",
                      "apiVersion": "2021-06-01",
                      "name": "[format('{0}/{1}', parameters('PrivateCloudName'), 'srm')]",
                      "properties": {
                        "licenseKey": "[parameters('SRMLicenseKey')]",
                        "addonType": "SRM"
                      }
                    },
                    {
                      "type": "Microsoft.AVS/privateClouds/addons",
                      "apiVersion": "2021-06-01",
                      "name": "[format('{0}/{1}', parameters('PrivateCloudName'), 'vr')]",
                      "properties": {
                        "vrsCount": "[parameters('VRServerCount')]",
                        "addonType": "VR"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.AVS/privateClouds/addons', parameters('PrivateCloudName'), 'srm')]"
                      ]
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('{0}-AVS', variables('deploymentPrefix')))]"
      ]
    },
    {
      "condition": "[parameters('DeployJumpbox')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-Jumpbox', variables('deploymentPrefix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "Prefix": {
            "value": "[parameters('Prefix')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "Username": {
            "value": "[parameters('JumpboxUsername')]"
          },
          "Password": {
            "value": "[parameters('JumpboxPassword')]"
          },
          "VNetName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('{0}-Network', variables('deploymentPrefix')))).outputs.VNetName.value]"
          },
          "VNetResourceGroup": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('{0}-Network', variables('deploymentPrefix')))).outputs.NetworkResourceGroup.value]"
          },
          "BastionSubnet": {
            "value": "[parameters('BastionSubnet')]"
          },
          "JumpboxSubnet": {
            "value": "[parameters('JumpboxSubnet')]"
          },
          "JumpboxSku": {
            "value": "[parameters('JumpboxSku')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.6.1.6515",
              "templateHash": "11319283237666124989"
            }
          },
          "parameters": {
            "Prefix": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "Username": {
              "type": "secureString"
            },
            "Password": {
              "type": "secureString"
            },
            "VNetResourceGroup": {
              "type": "string"
            },
            "VNetName": {
              "type": "string"
            },
            "JumpboxSubnet": {
              "type": "string"
            },
            "JumpboxSku": {
              "type": "string"
            },
            "BastionSubnet": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[format('{0}-Jumpbox', parameters('Prefix'))]",
              "location": "[parameters('Location')]"
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "Jumpbox-Subnet",
              "resourceGroup": "[parameters('VNetResourceGroup')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "VNetName": {
                    "value": "[parameters('VNetName')]"
                  },
                  "BastionSubnet": {
                    "value": "[parameters('BastionSubnet')]"
                  },
                  "JumpboxSubnet": {
                    "value": "[parameters('JumpboxSubnet')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.6.1.6515",
                      "templateHash": "8543419909059733522"
                    }
                  },
                  "parameters": {
                    "VNetName": {
                      "type": "string"
                    },
                    "JumpboxSubnet": {
                      "type": "string"
                    },
                    "BastionSubnet": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/subnets",
                      "apiVersion": "2021-02-01",
                      "name": "[format('{0}/{1}', parameters('VNetName'), 'JumpBox')]",
                      "properties": {
                        "addressPrefix": "[parameters('JumpboxSubnet')]"
                      }
                    },
                    {
                      "type": "Microsoft.Network/virtualNetworks/subnets",
                      "apiVersion": "2021-02-01",
                      "name": "[format('{0}/{1}', parameters('VNetName'), 'AzureBastionSubnet')]",
                      "properties": {
                        "addressPrefix": "[parameters('BastionSubnet')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('VNetName'), 'JumpBox')]"
                      ]
                    }
                  ],
                  "outputs": {
                    "JumpBoxSubnetId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('VNetName'), 'JumpBox')]"
                    },
                    "BastionSubnetId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('VNetName'), 'AzureBastionSubnet')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('{0}-Bastion', deployment().name)]",
              "resourceGroup": "[format('{0}-Jumpbox', parameters('Prefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Prefix": {
                    "value": "[parameters('Prefix')]"
                  },
                  "SubnetId": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('VNetResourceGroup')), 'Microsoft.Resources/deployments', 'Jumpbox-Subnet')).outputs.BastionSubnetId.value]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.6.1.6515",
                      "templateHash": "5239014488520326448"
                    }
                  },
                  "parameters": {
                    "Prefix": {
                      "type": "string"
                    },
                    "SubnetId": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2020-05-01",
                      "name": "[format('{0}-bastion-pip', parameters('Prefix'))]",
                      "location": "[parameters('Location')]",
                      "sku": {
                        "name": "Standard"
                      },
                      "properties": {
                        "publicIPAllocationMethod": "Static"
                      }
                    },
                    {
                      "type": "Microsoft.Network/bastionHosts",
                      "apiVersion": "2020-05-01",
                      "name": "[format('{0}-bastion', parameters('Prefix'))]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "IpConf",
                            "properties": {
                              "subnet": {
                                "id": "[parameters('SubnetId')]"
                              },
                              "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-bastion-pip', parameters('Prefix')))]"
                              }
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-bastion-pip', parameters('Prefix')))]"
                      ]
                    }
                  ]
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-Jumpbox', parameters('Prefix')))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('VNetResourceGroup')), 'Microsoft.Resources/deployments', 'Jumpbox-Subnet')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('{0}-VM', deployment().name)]",
              "resourceGroup": "[format('{0}-Jumpbox', parameters('Prefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Prefix": {
                    "value": "[parameters('Prefix')]"
                  },
                  "SubnetId": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('VNetResourceGroup')), 'Microsoft.Resources/deployments', 'Jumpbox-Subnet')).outputs.JumpBoxSubnetId.value]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "Username": {
                    "value": "[parameters('Username')]"
                  },
                  "Password": {
                    "value": "[parameters('Password')]"
                  },
                  "VMSize": {
                    "value": "[parameters('JumpboxSku')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.6.1.6515",
                      "templateHash": "775628613345942777"
                    }
                  },
                  "parameters": {
                    "Prefix": {
                      "type": "string"
                    },
                    "SubnetId": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "Username": {
                      "type": "string"
                    },
                    "Password": {
                      "type": "secureString"
                    },
                    "VMSize": {
                      "type": "string"
                    },
                    "OSVersion": {
                      "type": "string",
                      "defaultValue": "2019-Datacenter-smalldisk"
                    }
                  },
                  "variables": {
                    "Name": "[format('{0}-jumpbox', parameters('Prefix'))]",
                    "Hostname": "avsjumpbox"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2021-02-01",
                      "name": "[variables('Name')]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "ipconfig1",
                            "properties": {
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[parameters('SubnetId')]"
                              }
                            }
                          }
                        ]
                      }
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2021-03-01",
                      "name": "[variables('Name')]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "hardwareProfile": {
                          "vmSize": "[parameters('VMSize')]"
                        },
                        "osProfile": {
                          "computerName": "[variables('Hostname')]",
                          "adminUsername": "[parameters('Username')]",
                          "adminPassword": "[parameters('Password')]"
                        },
                        "storageProfile": {
                          "imageReference": {
                            "publisher": "MicrosoftWindowsServer",
                            "offer": "WindowsServer",
                            "sku": "[parameters('OSVersion')]",
                            "version": "latest"
                          },
                          "osDisk": {
                            "createOption": "FromImage",
                            "managedDisk": {
                              "storageAccountType": "Premium_LRS"
                            }
                          }
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('Name'))]"
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', variables('Name'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "JumpboxResourceId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Compute/virtualMachines', variables('Name'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-Jumpbox', parameters('Prefix')))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('VNetResourceGroup')), 'Microsoft.Resources/deployments', 'Jumpbox-Subnet')]"
              ]
            }
          ],
          "outputs": {
            "JumpboxResourceId": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-Jumpbox', parameters('Prefix'))), 'Microsoft.Resources/deployments', format('{0}-VM', deployment().name))).outputs.JumpboxResourceId.value]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('{0}-Network', variables('deploymentPrefix')))]"
      ]
    }
  ]
}