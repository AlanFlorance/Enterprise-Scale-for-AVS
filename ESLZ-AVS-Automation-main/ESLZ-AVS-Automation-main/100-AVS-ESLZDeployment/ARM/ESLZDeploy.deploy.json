{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.4.613.9944",
      "templateHash": "14842534960835551644"
    }
  },
  "parameters": {
    "PrimaryLocation": {
      "type": "string"
    },
    "SecondaryLocation": {
      "type": "string"
    },
    "Prefix": {
      "type": "string",
      "defaultValue": "AVS"
    },
    "NetworkLayout": {
      "type": "object",
      "defaultValue": {
        "PrimaryRegion": {
          "PrivateCloudAddressSpace": "10.110.0.0/22",
          "VNetAddressSpace": "10.111.0.0/16",
          "VNetGatewaySubnet": "10.111.0.0/24"
        },
        "SecondaryRegion": {
          "PrivateCloudAddressSpace": "10.120.0.0/22",
          "VNetAddressSpace": "10.121.0.0/16",
          "VNetGatewaySubnet": "10.121.0.0/24"
        }
      }
    },
    "InternetViaVWan": {
      "type": "bool",
      "defaultValue": false
    },
    "AlertEmails": {
      "type": "array",
      "defaultValue": [
        "scholden@microsoft.com"
      ]
    }
  },
  "functions": [],
  "variables": {
    "PrimaryPrefix": "[format('{0}-Primary', parameters('Prefix'))]",
    "SecondaryPrefix": "[format('{0}-Secondary', parameters('Prefix'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "PrimaryRegion",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "Prefix": {
            "value": "[variables('PrimaryPrefix')]"
          },
          "Location": {
            "value": "[parameters('PrimaryLocation')]"
          },
          "PrivateCloudAddressSpace": {
            "value": "[parameters('NetworkLayout').PrimaryRegion.PrivateCloudAddressSpace]"
          },
          "VNetAddressSpace": {
            "value": "[parameters('NetworkLayout').PrimaryRegion.VNetAddressSpace]"
          },
          "VNetGatewaySubnet": {
            "value": "[parameters('NetworkLayout').PrimaryRegion.VNetGatewaySubnet]"
          },
          "PrivateCloudInternetEnabled": {
            "value": "[not(parameters('InternetViaVWan'))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "5408233826664393318"
            }
          },
          "parameters": {
            "Location": {
              "type": "string"
            },
            "Prefix": {
              "type": "string"
            },
            "PrivateCloudAddressSpace": {
              "type": "string"
            },
            "VNetAddressSpace": {
              "type": "string"
            },
            "VNetGatewaySubnet": {
              "type": "string"
            },
            "PrivateCloudInternetEnabled": {
              "type": "bool"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[format('{0}-PrivateCloud', parameters('Prefix'))]",
              "location": "[parameters('Location')]"
            },
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[format('{0}-Network', parameters('Prefix'))]",
              "location": "[parameters('Location')]"
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "PrivateCloud",
              "resourceGroup": "[format('{0}-PrivateCloud', parameters('Prefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Prefix": {
                    "value": "[parameters('Prefix')]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "NetworkBlock": {
                    "value": "[parameters('PrivateCloudAddressSpace')]"
                  },
                  "InternetEnabled": {
                    "value": "[parameters('PrivateCloudInternetEnabled')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "12228243956151524414"
                    }
                  },
                  "parameters": {
                    "Prefix": {
                      "type": "string"
                    },
                    "NetworkBlock": {
                      "type": "string"
                    },
                    "ManagementClusterSize": {
                      "type": "int",
                      "defaultValue": 3
                    },
                    "Location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    },
                    "InternetEnabled": {
                      "type": "bool"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.AVS/privateClouds",
                      "apiVersion": "2021-06-01",
                      "name": "[parameters('Prefix')]",
                      "sku": {
                        "name": "AV36"
                      },
                      "location": "[parameters('Location')]",
                      "properties": {
                        "networkBlock": "[parameters('NetworkBlock')]",
                        "internet": "[if(parameters('InternetEnabled'), 'Enabled', 'Disabled')]",
                        "managementCluster": {
                          "clusterSize": "[parameters('ManagementClusterSize')]"
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "PrivateCloudName": {
                      "type": "string",
                      "value": "[parameters('Prefix')]"
                    },
                    "PrivateCloudResourceId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.AVS/privateClouds', parameters('Prefix'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-PrivateCloud', parameters('Prefix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "Network",
              "resourceGroup": "[format('{0}-Network', parameters('Prefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Prefix": {
                    "value": "[parameters('Prefix')]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "VNetAddressSpace": {
                    "value": "[parameters('VNetAddressSpace')]"
                  },
                  "VNetGatewaySubnet": {
                    "value": "[parameters('VNetGatewaySubnet')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "17830615809241139250"
                    }
                  },
                  "parameters": {
                    "Location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    },
                    "Prefix": {
                      "type": "string"
                    },
                    "VNetAddressSpace": {
                      "type": "string"
                    },
                    "VNetGatewaySubnet": {
                      "type": "string"
                    },
                    "GatewaySku": {
                      "type": "string",
                      "defaultValue": "Standard"
                    }
                  },
                  "functions": [],
                  "variables": {
                    "GatewayName": "[format('{0}-GW', parameters('Prefix'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks",
                      "apiVersion": "2021-02-01",
                      "name": "[format('{0}-VNet', parameters('Prefix'))]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "addressSpace": {
                          "addressPrefixes": [
                            "[parameters('VNetAddressSpace')]"
                          ]
                        },
                        "subnets": [
                          {
                            "name": "GatewaySubnet",
                            "properties": {
                              "addressPrefix": "[parameters('VNetGatewaySubnet')]"
                            }
                          }
                        ]
                      }
                    },
                    {
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2021-02-01",
                      "name": "[format('{0}-PIP', variables('GatewayName'))]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "publicIPAllocationMethod": "Dynamic"
                      },
                      "sku": {
                        "name": "Basic",
                        "tier": "Regional"
                      }
                    },
                    {
                      "type": "Microsoft.Network/virtualNetworkGateways",
                      "apiVersion": "2021-02-01",
                      "name": "[variables('GatewayName')]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "gatewayType": "ExpressRoute",
                        "sku": {
                          "name": "[parameters('GatewaySku')]",
                          "tier": "[parameters('GatewaySku')]"
                        },
                        "ipConfigurations": [
                          {
                            "name": "default",
                            "properties": {
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[format('{0}/subnets/GatewaySubnet', resourceId('Microsoft.Network/virtualNetworks', format('{0}-VNet', parameters('Prefix'))))]"
                              },
                              "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-PIP', variables('GatewayName')))]"
                              }
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-PIP', variables('GatewayName')))]",
                        "[resourceId('Microsoft.Network/virtualNetworks', format('{0}-VNet', parameters('Prefix')))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "VNetName": {
                      "type": "string",
                      "value": "[format('{0}-VNet', parameters('Prefix'))]"
                    },
                    "GatewayName": {
                      "type": "string",
                      "value": "[variables('GatewayName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-Network', parameters('Prefix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "AVSExRVNetConnection",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "GatewayName": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-Network', parameters('Prefix'))), 'Microsoft.Resources/deployments', 'Network'), '2019-10-01').outputs.GatewayName.value]"
                  },
                  "NetworkResourceGroup": {
                    "value": "[format('{0}-Network', parameters('Prefix'))]"
                  },
                  "VNetPrefix": {
                    "value": "[parameters('Prefix')]"
                  },
                  "PrivateCloudName": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-PrivateCloud', parameters('Prefix'))), 'Microsoft.Resources/deployments', 'PrivateCloud'), '2019-10-01').outputs.PrivateCloudName.value]"
                  },
                  "PrivateCloudResourceGroup": {
                    "value": "[format('{0}-PrivateCloud', parameters('Prefix'))]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "6235644417574720045"
                    }
                  },
                  "parameters": {
                    "VNetPrefix": {
                      "type": "string"
                    },
                    "AVSPrefix": {
                      "type": "string",
                      "defaultValue": "[parameters('VNetPrefix')]"
                    },
                    "PrivateCloudResourceGroup": {
                      "type": "string"
                    },
                    "PrivateCloudName": {
                      "type": "string"
                    },
                    "NetworkResourceGroup": {
                      "type": "string"
                    },
                    "GatewayName": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "AVSExRAuthorization",
                      "resourceGroup": "[parameters('PrivateCloudResourceGroup')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "ConnectionName": {
                            "value": "[format('{0}-VNet', parameters('VNetPrefix'))]"
                          },
                          "PrivateCloudName": {
                            "value": "[parameters('PrivateCloudName')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.613.9944",
                              "templateHash": "2808681075634867814"
                            }
                          },
                          "parameters": {
                            "PrivateCloudName": {
                              "type": "string"
                            },
                            "ConnectionName": {
                              "type": "string"
                            }
                          },
                          "functions": [],
                          "resources": [
                            {
                              "type": "Microsoft.AVS/privateClouds/authorizations",
                              "apiVersion": "2021-06-01",
                              "name": "[format('{0}/{1}', parameters('PrivateCloudName'), parameters('ConnectionName'))]"
                            }
                          ],
                          "outputs": {
                            "ExpressRouteAuthorizationKey": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.AVS/privateClouds/authorizations', parameters('PrivateCloudName'), parameters('ConnectionName'))).expressRouteAuthorizationKey]"
                            },
                            "ExpressRouteId": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.AVS/privateClouds', parameters('PrivateCloudName')), '2021-06-01').circuit.expressRouteID]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "VNetExRConnection",
                      "resourceGroup": "[parameters('NetworkResourceGroup')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "ConnectionName": {
                            "value": "[format('{0}-AVS', parameters('AVSPrefix'))]"
                          },
                          "GatewayName": {
                            "value": "[parameters('GatewayName')]"
                          },
                          "ExpressRouteAuthorizationKey": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('PrivateCloudResourceGroup')), 'Microsoft.Resources/deployments', 'AVSExRAuthorization'), '2019-10-01').outputs.ExpressRouteAuthorizationKey.value]"
                          },
                          "ExpressRouteId": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('PrivateCloudResourceGroup')), 'Microsoft.Resources/deployments', 'AVSExRAuthorization'), '2019-10-01').outputs.ExpressRouteId.value]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.613.9944",
                              "templateHash": "8792397395336088137"
                            }
                          },
                          "parameters": {
                            "GatewayName": {
                              "type": "string"
                            },
                            "ConnectionName": {
                              "type": "string"
                            },
                            "Location": {
                              "type": "string",
                              "defaultValue": "[resourceGroup().location]"
                            },
                            "ExpressRouteAuthorizationKey": {
                              "type": "secureString"
                            },
                            "ExpressRouteId": {
                              "type": "secureString"
                            }
                          },
                          "functions": [],
                          "resources": [
                            {
                              "type": "Microsoft.Network/connections",
                              "apiVersion": "2021-02-01",
                              "name": "[parameters('ConnectionName')]",
                              "location": "[parameters('Location')]",
                              "properties": {
                                "connectionType": "ExpressRoute",
                                "routingWeight": 0,
                                "virtualNetworkGateway1": {
                                  "id": "[resourceId('Microsoft.Network/virtualNetworkGateways', parameters('GatewayName'))]",
                                  "properties": {}
                                },
                                "peer": {
                                  "id": "[parameters('ExpressRouteId')]"
                                },
                                "authorizationKey": "[parameters('ExpressRouteAuthorizationKey')]"
                              }
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('PrivateCloudResourceGroup')), 'Microsoft.Resources/deployments', 'AVSExRAuthorization')]"
                      ]
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-Network', parameters('Prefix'))), 'Microsoft.Resources/deployments', 'Network')]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-Network', parameters('Prefix')))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-PrivateCloud', parameters('Prefix'))), 'Microsoft.Resources/deployments', 'PrivateCloud')]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-PrivateCloud', parameters('Prefix')))]"
              ]
            }
          ],
          "outputs": {
            "PrivateCloudName": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-PrivateCloud', parameters('Prefix'))), 'Microsoft.Resources/deployments', 'PrivateCloud'), '2019-10-01').outputs.PrivateCloudName.value]"
            },
            "PrivateCloudResourceGroupName": {
              "type": "string",
              "value": "[format('{0}-PrivateCloud', parameters('Prefix'))]"
            },
            "PrivateCloudResourceId": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-PrivateCloud', parameters('Prefix'))), 'Microsoft.Resources/deployments', 'PrivateCloud'), '2019-10-01').outputs.PrivateCloudResourceId.value]"
            },
            "GatewayName": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-Network', parameters('Prefix'))), 'Microsoft.Resources/deployments', 'Network'), '2019-10-01').outputs.GatewayName.value]"
            },
            "VNetName": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-Network', parameters('Prefix'))), 'Microsoft.Resources/deployments', 'Network'), '2019-10-01').outputs.VNetName.value]"
            },
            "NetworkResourceGroup": {
              "type": "string",
              "value": "[format('{0}-Network', parameters('Prefix'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "SecondaryRegion",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "Prefix": {
            "value": "[variables('SecondaryPrefix')]"
          },
          "Location": {
            "value": "[parameters('SecondaryLocation')]"
          },
          "PrivateCloudAddressSpace": {
            "value": "[parameters('NetworkLayout').SecondaryRegion.PrivateCloudAddressSpace]"
          },
          "VNetAddressSpace": {
            "value": "[parameters('NetworkLayout').SecondaryRegion.VNetAddressSpace]"
          },
          "VNetGatewaySubnet": {
            "value": "[parameters('NetworkLayout').SecondaryRegion.VNetGatewaySubnet]"
          },
          "PrivateCloudInternetEnabled": {
            "value": "[not(parameters('InternetViaVWan'))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "5408233826664393318"
            }
          },
          "parameters": {
            "Location": {
              "type": "string"
            },
            "Prefix": {
              "type": "string"
            },
            "PrivateCloudAddressSpace": {
              "type": "string"
            },
            "VNetAddressSpace": {
              "type": "string"
            },
            "VNetGatewaySubnet": {
              "type": "string"
            },
            "PrivateCloudInternetEnabled": {
              "type": "bool"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[format('{0}-PrivateCloud', parameters('Prefix'))]",
              "location": "[parameters('Location')]"
            },
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[format('{0}-Network', parameters('Prefix'))]",
              "location": "[parameters('Location')]"
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "PrivateCloud",
              "resourceGroup": "[format('{0}-PrivateCloud', parameters('Prefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Prefix": {
                    "value": "[parameters('Prefix')]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "NetworkBlock": {
                    "value": "[parameters('PrivateCloudAddressSpace')]"
                  },
                  "InternetEnabled": {
                    "value": "[parameters('PrivateCloudInternetEnabled')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "12228243956151524414"
                    }
                  },
                  "parameters": {
                    "Prefix": {
                      "type": "string"
                    },
                    "NetworkBlock": {
                      "type": "string"
                    },
                    "ManagementClusterSize": {
                      "type": "int",
                      "defaultValue": 3
                    },
                    "Location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    },
                    "InternetEnabled": {
                      "type": "bool"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.AVS/privateClouds",
                      "apiVersion": "2021-06-01",
                      "name": "[parameters('Prefix')]",
                      "sku": {
                        "name": "AV36"
                      },
                      "location": "[parameters('Location')]",
                      "properties": {
                        "networkBlock": "[parameters('NetworkBlock')]",
                        "internet": "[if(parameters('InternetEnabled'), 'Enabled', 'Disabled')]",
                        "managementCluster": {
                          "clusterSize": "[parameters('ManagementClusterSize')]"
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "PrivateCloudName": {
                      "type": "string",
                      "value": "[parameters('Prefix')]"
                    },
                    "PrivateCloudResourceId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.AVS/privateClouds', parameters('Prefix'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-PrivateCloud', parameters('Prefix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "Network",
              "resourceGroup": "[format('{0}-Network', parameters('Prefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Prefix": {
                    "value": "[parameters('Prefix')]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "VNetAddressSpace": {
                    "value": "[parameters('VNetAddressSpace')]"
                  },
                  "VNetGatewaySubnet": {
                    "value": "[parameters('VNetGatewaySubnet')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "17830615809241139250"
                    }
                  },
                  "parameters": {
                    "Location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    },
                    "Prefix": {
                      "type": "string"
                    },
                    "VNetAddressSpace": {
                      "type": "string"
                    },
                    "VNetGatewaySubnet": {
                      "type": "string"
                    },
                    "GatewaySku": {
                      "type": "string",
                      "defaultValue": "Standard"
                    }
                  },
                  "functions": [],
                  "variables": {
                    "GatewayName": "[format('{0}-GW', parameters('Prefix'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks",
                      "apiVersion": "2021-02-01",
                      "name": "[format('{0}-VNet', parameters('Prefix'))]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "addressSpace": {
                          "addressPrefixes": [
                            "[parameters('VNetAddressSpace')]"
                          ]
                        },
                        "subnets": [
                          {
                            "name": "GatewaySubnet",
                            "properties": {
                              "addressPrefix": "[parameters('VNetGatewaySubnet')]"
                            }
                          }
                        ]
                      }
                    },
                    {
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2021-02-01",
                      "name": "[format('{0}-PIP', variables('GatewayName'))]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "publicIPAllocationMethod": "Dynamic"
                      },
                      "sku": {
                        "name": "Basic",
                        "tier": "Regional"
                      }
                    },
                    {
                      "type": "Microsoft.Network/virtualNetworkGateways",
                      "apiVersion": "2021-02-01",
                      "name": "[variables('GatewayName')]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "gatewayType": "ExpressRoute",
                        "sku": {
                          "name": "[parameters('GatewaySku')]",
                          "tier": "[parameters('GatewaySku')]"
                        },
                        "ipConfigurations": [
                          {
                            "name": "default",
                            "properties": {
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[format('{0}/subnets/GatewaySubnet', resourceId('Microsoft.Network/virtualNetworks', format('{0}-VNet', parameters('Prefix'))))]"
                              },
                              "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-PIP', variables('GatewayName')))]"
                              }
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-PIP', variables('GatewayName')))]",
                        "[resourceId('Microsoft.Network/virtualNetworks', format('{0}-VNet', parameters('Prefix')))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "VNetName": {
                      "type": "string",
                      "value": "[format('{0}-VNet', parameters('Prefix'))]"
                    },
                    "GatewayName": {
                      "type": "string",
                      "value": "[variables('GatewayName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-Network', parameters('Prefix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "AVSExRVNetConnection",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "GatewayName": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-Network', parameters('Prefix'))), 'Microsoft.Resources/deployments', 'Network'), '2019-10-01').outputs.GatewayName.value]"
                  },
                  "NetworkResourceGroup": {
                    "value": "[format('{0}-Network', parameters('Prefix'))]"
                  },
                  "VNetPrefix": {
                    "value": "[parameters('Prefix')]"
                  },
                  "PrivateCloudName": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-PrivateCloud', parameters('Prefix'))), 'Microsoft.Resources/deployments', 'PrivateCloud'), '2019-10-01').outputs.PrivateCloudName.value]"
                  },
                  "PrivateCloudResourceGroup": {
                    "value": "[format('{0}-PrivateCloud', parameters('Prefix'))]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "6235644417574720045"
                    }
                  },
                  "parameters": {
                    "VNetPrefix": {
                      "type": "string"
                    },
                    "AVSPrefix": {
                      "type": "string",
                      "defaultValue": "[parameters('VNetPrefix')]"
                    },
                    "PrivateCloudResourceGroup": {
                      "type": "string"
                    },
                    "PrivateCloudName": {
                      "type": "string"
                    },
                    "NetworkResourceGroup": {
                      "type": "string"
                    },
                    "GatewayName": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "AVSExRAuthorization",
                      "resourceGroup": "[parameters('PrivateCloudResourceGroup')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "ConnectionName": {
                            "value": "[format('{0}-VNet', parameters('VNetPrefix'))]"
                          },
                          "PrivateCloudName": {
                            "value": "[parameters('PrivateCloudName')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.613.9944",
                              "templateHash": "2808681075634867814"
                            }
                          },
                          "parameters": {
                            "PrivateCloudName": {
                              "type": "string"
                            },
                            "ConnectionName": {
                              "type": "string"
                            }
                          },
                          "functions": [],
                          "resources": [
                            {
                              "type": "Microsoft.AVS/privateClouds/authorizations",
                              "apiVersion": "2021-06-01",
                              "name": "[format('{0}/{1}', parameters('PrivateCloudName'), parameters('ConnectionName'))]"
                            }
                          ],
                          "outputs": {
                            "ExpressRouteAuthorizationKey": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.AVS/privateClouds/authorizations', parameters('PrivateCloudName'), parameters('ConnectionName'))).expressRouteAuthorizationKey]"
                            },
                            "ExpressRouteId": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.AVS/privateClouds', parameters('PrivateCloudName')), '2021-06-01').circuit.expressRouteID]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "VNetExRConnection",
                      "resourceGroup": "[parameters('NetworkResourceGroup')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "ConnectionName": {
                            "value": "[format('{0}-AVS', parameters('AVSPrefix'))]"
                          },
                          "GatewayName": {
                            "value": "[parameters('GatewayName')]"
                          },
                          "ExpressRouteAuthorizationKey": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('PrivateCloudResourceGroup')), 'Microsoft.Resources/deployments', 'AVSExRAuthorization'), '2019-10-01').outputs.ExpressRouteAuthorizationKey.value]"
                          },
                          "ExpressRouteId": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('PrivateCloudResourceGroup')), 'Microsoft.Resources/deployments', 'AVSExRAuthorization'), '2019-10-01').outputs.ExpressRouteId.value]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.613.9944",
                              "templateHash": "8792397395336088137"
                            }
                          },
                          "parameters": {
                            "GatewayName": {
                              "type": "string"
                            },
                            "ConnectionName": {
                              "type": "string"
                            },
                            "Location": {
                              "type": "string",
                              "defaultValue": "[resourceGroup().location]"
                            },
                            "ExpressRouteAuthorizationKey": {
                              "type": "secureString"
                            },
                            "ExpressRouteId": {
                              "type": "secureString"
                            }
                          },
                          "functions": [],
                          "resources": [
                            {
                              "type": "Microsoft.Network/connections",
                              "apiVersion": "2021-02-01",
                              "name": "[parameters('ConnectionName')]",
                              "location": "[parameters('Location')]",
                              "properties": {
                                "connectionType": "ExpressRoute",
                                "routingWeight": 0,
                                "virtualNetworkGateway1": {
                                  "id": "[resourceId('Microsoft.Network/virtualNetworkGateways', parameters('GatewayName'))]",
                                  "properties": {}
                                },
                                "peer": {
                                  "id": "[parameters('ExpressRouteId')]"
                                },
                                "authorizationKey": "[parameters('ExpressRouteAuthorizationKey')]"
                              }
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('PrivateCloudResourceGroup')), 'Microsoft.Resources/deployments', 'AVSExRAuthorization')]"
                      ]
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-Network', parameters('Prefix'))), 'Microsoft.Resources/deployments', 'Network')]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-Network', parameters('Prefix')))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-PrivateCloud', parameters('Prefix'))), 'Microsoft.Resources/deployments', 'PrivateCloud')]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-PrivateCloud', parameters('Prefix')))]"
              ]
            }
          ],
          "outputs": {
            "PrivateCloudName": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-PrivateCloud', parameters('Prefix'))), 'Microsoft.Resources/deployments', 'PrivateCloud'), '2019-10-01').outputs.PrivateCloudName.value]"
            },
            "PrivateCloudResourceGroupName": {
              "type": "string",
              "value": "[format('{0}-PrivateCloud', parameters('Prefix'))]"
            },
            "PrivateCloudResourceId": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-PrivateCloud', parameters('Prefix'))), 'Microsoft.Resources/deployments', 'PrivateCloud'), '2019-10-01').outputs.PrivateCloudResourceId.value]"
            },
            "GatewayName": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-Network', parameters('Prefix'))), 'Microsoft.Resources/deployments', 'Network'), '2019-10-01').outputs.GatewayName.value]"
            },
            "VNetName": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-Network', parameters('Prefix'))), 'Microsoft.Resources/deployments', 'Network'), '2019-10-01').outputs.VNetName.value]"
            },
            "NetworkResourceGroup": {
              "type": "string",
              "value": "[format('{0}-Network', parameters('Prefix'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "CrossConnectivity",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "PrimaryPrefix": {
            "value": "[variables('PrimaryPrefix')]"
          },
          "PrimaryPrivateCloudName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'PrimaryRegion'), '2019-10-01').outputs.PrivateCloudName.value]"
          },
          "PrimaryPrivateCloudResourceGroup": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'PrimaryRegion'), '2019-10-01').outputs.PrivateCloudResourceGroupName.value]"
          },
          "PrimaryVNetName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'PrimaryRegion'), '2019-10-01').outputs.VNetName.value]"
          },
          "PrimaryGatewayName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'PrimaryRegion'), '2019-10-01').outputs.GatewayName.value]"
          },
          "PrimaryNetworkResourceGroup": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'PrimaryRegion'), '2019-10-01').outputs.NetworkResourceGroup.value]"
          },
          "SecondaryPrefix": {
            "value": "[variables('SecondaryPrefix')]"
          },
          "SecondaryPrivateCloudName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'SecondaryRegion'), '2019-10-01').outputs.PrivateCloudName.value]"
          },
          "SecondaryPrivateCloudResourceGroup": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'SecondaryRegion'), '2019-10-01').outputs.PrivateCloudResourceGroupName.value]"
          },
          "SecondaryVNetName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'SecondaryRegion'), '2019-10-01').outputs.VNetName.value]"
          },
          "SecondaryGatewayName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'SecondaryRegion'), '2019-10-01').outputs.GatewayName.value]"
          },
          "SecondaryNetworkResourceGroup": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'SecondaryRegion'), '2019-10-01').outputs.NetworkResourceGroup.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "600965919823041120"
            }
          },
          "parameters": {
            "PrimaryPrefix": {
              "type": "string"
            },
            "PrimaryPrivateCloudName": {
              "type": "string"
            },
            "PrimaryPrivateCloudResourceGroup": {
              "type": "string"
            },
            "PrimaryVNetName": {
              "type": "string"
            },
            "PrimaryGatewayName": {
              "type": "string"
            },
            "PrimaryNetworkResourceGroup": {
              "type": "string"
            },
            "SecondaryPrefix": {
              "type": "string"
            },
            "SecondaryPrivateCloudName": {
              "type": "string"
            },
            "SecondaryPrivateCloudResourceGroup": {
              "type": "string"
            },
            "SecondaryVNetName": {
              "type": "string"
            },
            "SecondaryGatewayName": {
              "type": "string"
            },
            "SecondaryNetworkResourceGroup": {
              "type": "string"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "GlobalReach",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "PrimaryPrivateCloudName": {
                    "value": "[parameters('PrimaryPrivateCloudName')]"
                  },
                  "PrimaryPrivateCloudResourceGroup": {
                    "value": "[parameters('PrimaryPrivateCloudResourceGroup')]"
                  },
                  "SecondaryPrivateCloudName": {
                    "value": "[parameters('SecondaryPrivateCloudName')]"
                  },
                  "SecondaryPrivateCloudResourceGroup": {
                    "value": "[parameters('SecondaryPrivateCloudResourceGroup')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "10048968859136914317"
                    }
                  },
                  "parameters": {
                    "PrimaryPrivateCloudName": {
                      "type": "string"
                    },
                    "PrimaryPrivateCloudResourceGroup": {
                      "type": "string"
                    },
                    "SecondaryPrivateCloudName": {
                      "type": "string"
                    },
                    "SecondaryPrivateCloudResourceGroup": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "SecondaryAuthKey",
                      "resourceGroup": "[parameters('SecondaryPrivateCloudResourceGroup')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "ConnectionName": {
                            "value": "[format('GR-{0}', parameters('PrimaryPrivateCloudName'))]"
                          },
                          "PrivateCloudName": {
                            "value": "[parameters('SecondaryPrivateCloudName')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.613.9944",
                              "templateHash": "2808681075634867814"
                            }
                          },
                          "parameters": {
                            "PrivateCloudName": {
                              "type": "string"
                            },
                            "ConnectionName": {
                              "type": "string"
                            }
                          },
                          "functions": [],
                          "resources": [
                            {
                              "type": "Microsoft.AVS/privateClouds/authorizations",
                              "apiVersion": "2021-06-01",
                              "name": "[format('{0}/{1}', parameters('PrivateCloudName'), parameters('ConnectionName'))]"
                            }
                          ],
                          "outputs": {
                            "ExpressRouteAuthorizationKey": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.AVS/privateClouds/authorizations', parameters('PrivateCloudName'), parameters('ConnectionName'))).expressRouteAuthorizationKey]"
                            },
                            "ExpressRouteId": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.AVS/privateClouds', parameters('PrivateCloudName')), '2021-06-01').circuit.expressRouteID]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "GlobalReach",
                      "resourceGroup": "[parameters('PrimaryPrivateCloudResourceGroup')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "PrivateCloudName": {
                            "value": "[parameters('PrimaryPrivateCloudName')]"
                          },
                          "ExpressRouteId": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('SecondaryPrivateCloudResourceGroup')), 'Microsoft.Resources/deployments', 'SecondaryAuthKey'), '2019-10-01').outputs.ExpressRouteId.value]"
                          },
                          "ExpressRouteAuthorizationKey": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('SecondaryPrivateCloudResourceGroup')), 'Microsoft.Resources/deployments', 'SecondaryAuthKey'), '2019-10-01').outputs.ExpressRouteAuthorizationKey.value]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.613.9944",
                              "templateHash": "10351735380447530768"
                            }
                          },
                          "parameters": {
                            "PrivateCloudName": {
                              "type": "string"
                            },
                            "ExpressRouteAuthorizationKey": {
                              "type": "secureString"
                            },
                            "ExpressRouteId": {
                              "type": "secureString"
                            }
                          },
                          "functions": [],
                          "resources": [
                            {
                              "type": "Microsoft.AVS/privateClouds/globalReachConnections",
                              "apiVersion": "2021-06-01",
                              "name": "[format('{0}/{1}', parameters('PrivateCloudName'), guid(parameters('ExpressRouteId'), parameters('ExpressRouteAuthorizationKey')))]",
                              "properties": {
                                "authorizationKey": "[parameters('ExpressRouteAuthorizationKey')]",
                                "peerExpressRouteCircuit": "[parameters('ExpressRouteId')]"
                              }
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('SecondaryPrivateCloudResourceGroup')), 'Microsoft.Resources/deployments', 'SecondaryAuthKey')]"
                      ]
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "PrimaryAVSToSecondaryVNet",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "AVSPrefix": {
                    "value": "[parameters('PrimaryPrefix')]"
                  },
                  "PrivateCloudName": {
                    "value": "[parameters('PrimaryPrivateCloudName')]"
                  },
                  "PrivateCloudResourceGroup": {
                    "value": "[parameters('PrimaryPrivateCloudResourceGroup')]"
                  },
                  "VNetPrefix": {
                    "value": "[parameters('SecondaryPrefix')]"
                  },
                  "GatewayName": {
                    "value": "[parameters('SecondaryGatewayName')]"
                  },
                  "NetworkResourceGroup": {
                    "value": "[parameters('SecondaryNetworkResourceGroup')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "6235644417574720045"
                    }
                  },
                  "parameters": {
                    "VNetPrefix": {
                      "type": "string"
                    },
                    "AVSPrefix": {
                      "type": "string",
                      "defaultValue": "[parameters('VNetPrefix')]"
                    },
                    "PrivateCloudResourceGroup": {
                      "type": "string"
                    },
                    "PrivateCloudName": {
                      "type": "string"
                    },
                    "NetworkResourceGroup": {
                      "type": "string"
                    },
                    "GatewayName": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "AVSExRAuthorization",
                      "resourceGroup": "[parameters('PrivateCloudResourceGroup')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "ConnectionName": {
                            "value": "[format('{0}-VNet', parameters('VNetPrefix'))]"
                          },
                          "PrivateCloudName": {
                            "value": "[parameters('PrivateCloudName')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.613.9944",
                              "templateHash": "2808681075634867814"
                            }
                          },
                          "parameters": {
                            "PrivateCloudName": {
                              "type": "string"
                            },
                            "ConnectionName": {
                              "type": "string"
                            }
                          },
                          "functions": [],
                          "resources": [
                            {
                              "type": "Microsoft.AVS/privateClouds/authorizations",
                              "apiVersion": "2021-06-01",
                              "name": "[format('{0}/{1}', parameters('PrivateCloudName'), parameters('ConnectionName'))]"
                            }
                          ],
                          "outputs": {
                            "ExpressRouteAuthorizationKey": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.AVS/privateClouds/authorizations', parameters('PrivateCloudName'), parameters('ConnectionName'))).expressRouteAuthorizationKey]"
                            },
                            "ExpressRouteId": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.AVS/privateClouds', parameters('PrivateCloudName')), '2021-06-01').circuit.expressRouteID]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "VNetExRConnection",
                      "resourceGroup": "[parameters('NetworkResourceGroup')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "ConnectionName": {
                            "value": "[format('{0}-AVS', parameters('AVSPrefix'))]"
                          },
                          "GatewayName": {
                            "value": "[parameters('GatewayName')]"
                          },
                          "ExpressRouteAuthorizationKey": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('PrivateCloudResourceGroup')), 'Microsoft.Resources/deployments', 'AVSExRAuthorization'), '2019-10-01').outputs.ExpressRouteAuthorizationKey.value]"
                          },
                          "ExpressRouteId": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('PrivateCloudResourceGroup')), 'Microsoft.Resources/deployments', 'AVSExRAuthorization'), '2019-10-01').outputs.ExpressRouteId.value]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.613.9944",
                              "templateHash": "8792397395336088137"
                            }
                          },
                          "parameters": {
                            "GatewayName": {
                              "type": "string"
                            },
                            "ConnectionName": {
                              "type": "string"
                            },
                            "Location": {
                              "type": "string",
                              "defaultValue": "[resourceGroup().location]"
                            },
                            "ExpressRouteAuthorizationKey": {
                              "type": "secureString"
                            },
                            "ExpressRouteId": {
                              "type": "secureString"
                            }
                          },
                          "functions": [],
                          "resources": [
                            {
                              "type": "Microsoft.Network/connections",
                              "apiVersion": "2021-02-01",
                              "name": "[parameters('ConnectionName')]",
                              "location": "[parameters('Location')]",
                              "properties": {
                                "connectionType": "ExpressRoute",
                                "routingWeight": 0,
                                "virtualNetworkGateway1": {
                                  "id": "[resourceId('Microsoft.Network/virtualNetworkGateways', parameters('GatewayName'))]",
                                  "properties": {}
                                },
                                "peer": {
                                  "id": "[parameters('ExpressRouteId')]"
                                },
                                "authorizationKey": "[parameters('ExpressRouteAuthorizationKey')]"
                              }
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('PrivateCloudResourceGroup')), 'Microsoft.Resources/deployments', 'AVSExRAuthorization')]"
                      ]
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "SecondaryAVSToPrimaryVNet",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "AVSPrefix": {
                    "value": "[parameters('SecondaryPrefix')]"
                  },
                  "PrivateCloudName": {
                    "value": "[parameters('SecondaryPrivateCloudName')]"
                  },
                  "PrivateCloudResourceGroup": {
                    "value": "[parameters('SecondaryPrivateCloudResourceGroup')]"
                  },
                  "VNetPrefix": {
                    "value": "[parameters('PrimaryPrefix')]"
                  },
                  "GatewayName": {
                    "value": "[parameters('PrimaryGatewayName')]"
                  },
                  "NetworkResourceGroup": {
                    "value": "[parameters('PrimaryNetworkResourceGroup')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "6235644417574720045"
                    }
                  },
                  "parameters": {
                    "VNetPrefix": {
                      "type": "string"
                    },
                    "AVSPrefix": {
                      "type": "string",
                      "defaultValue": "[parameters('VNetPrefix')]"
                    },
                    "PrivateCloudResourceGroup": {
                      "type": "string"
                    },
                    "PrivateCloudName": {
                      "type": "string"
                    },
                    "NetworkResourceGroup": {
                      "type": "string"
                    },
                    "GatewayName": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "AVSExRAuthorization",
                      "resourceGroup": "[parameters('PrivateCloudResourceGroup')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "ConnectionName": {
                            "value": "[format('{0}-VNet', parameters('VNetPrefix'))]"
                          },
                          "PrivateCloudName": {
                            "value": "[parameters('PrivateCloudName')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.613.9944",
                              "templateHash": "2808681075634867814"
                            }
                          },
                          "parameters": {
                            "PrivateCloudName": {
                              "type": "string"
                            },
                            "ConnectionName": {
                              "type": "string"
                            }
                          },
                          "functions": [],
                          "resources": [
                            {
                              "type": "Microsoft.AVS/privateClouds/authorizations",
                              "apiVersion": "2021-06-01",
                              "name": "[format('{0}/{1}', parameters('PrivateCloudName'), parameters('ConnectionName'))]"
                            }
                          ],
                          "outputs": {
                            "ExpressRouteAuthorizationKey": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.AVS/privateClouds/authorizations', parameters('PrivateCloudName'), parameters('ConnectionName'))).expressRouteAuthorizationKey]"
                            },
                            "ExpressRouteId": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.AVS/privateClouds', parameters('PrivateCloudName')), '2021-06-01').circuit.expressRouteID]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "VNetExRConnection",
                      "resourceGroup": "[parameters('NetworkResourceGroup')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "ConnectionName": {
                            "value": "[format('{0}-AVS', parameters('AVSPrefix'))]"
                          },
                          "GatewayName": {
                            "value": "[parameters('GatewayName')]"
                          },
                          "ExpressRouteAuthorizationKey": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('PrivateCloudResourceGroup')), 'Microsoft.Resources/deployments', 'AVSExRAuthorization'), '2019-10-01').outputs.ExpressRouteAuthorizationKey.value]"
                          },
                          "ExpressRouteId": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('PrivateCloudResourceGroup')), 'Microsoft.Resources/deployments', 'AVSExRAuthorization'), '2019-10-01').outputs.ExpressRouteId.value]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.613.9944",
                              "templateHash": "8792397395336088137"
                            }
                          },
                          "parameters": {
                            "GatewayName": {
                              "type": "string"
                            },
                            "ConnectionName": {
                              "type": "string"
                            },
                            "Location": {
                              "type": "string",
                              "defaultValue": "[resourceGroup().location]"
                            },
                            "ExpressRouteAuthorizationKey": {
                              "type": "secureString"
                            },
                            "ExpressRouteId": {
                              "type": "secureString"
                            }
                          },
                          "functions": [],
                          "resources": [
                            {
                              "type": "Microsoft.Network/connections",
                              "apiVersion": "2021-02-01",
                              "name": "[parameters('ConnectionName')]",
                              "location": "[parameters('Location')]",
                              "properties": {
                                "connectionType": "ExpressRoute",
                                "routingWeight": 0,
                                "virtualNetworkGateway1": {
                                  "id": "[resourceId('Microsoft.Network/virtualNetworkGateways', parameters('GatewayName'))]",
                                  "properties": {}
                                },
                                "peer": {
                                  "id": "[parameters('ExpressRouteId')]"
                                },
                                "authorizationKey": "[parameters('ExpressRouteAuthorizationKey')]"
                              }
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('PrivateCloudResourceGroup')), 'Microsoft.Resources/deployments', 'AVSExRAuthorization')]"
                      ]
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "VNetPeering",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "PrimaryVNetName": {
                    "value": "[parameters('PrimaryVNetName')]"
                  },
                  "PrimaryNetworkResourceGroup": {
                    "value": "[parameters('PrimaryNetworkResourceGroup')]"
                  },
                  "SecondaryVNetName": {
                    "value": "[parameters('SecondaryVNetName')]"
                  },
                  "SecondaryNetworkResourceGroup": {
                    "value": "[parameters('SecondaryNetworkResourceGroup')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "13593331594872396161"
                    }
                  },
                  "parameters": {
                    "PrimaryVNetName": {
                      "type": "string"
                    },
                    "PrimaryNetworkResourceGroup": {
                      "type": "string"
                    },
                    "SecondaryVNetName": {
                      "type": "string"
                    },
                    "SecondaryNetworkResourceGroup": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "PrimaryToSecondaryPeering",
                      "resourceGroup": "[parameters('PrimaryNetworkResourceGroup')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "RemoteVNetId": {
                            "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('SecondaryNetworkResourceGroup')), 'Microsoft.Network/virtualNetworks', parameters('SecondaryVNetName'))]"
                          },
                          "RemoteVNetName": {
                            "value": "[parameters('SecondaryVNetName')]"
                          },
                          "VNetName": {
                            "value": "[parameters('PrimaryVNetName')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.613.9944",
                              "templateHash": "14916132073348539772"
                            }
                          },
                          "parameters": {
                            "VNetName": {
                              "type": "string"
                            },
                            "RemoteVNetName": {
                              "type": "string"
                            },
                            "RemoteVNetId": {
                              "type": "string"
                            }
                          },
                          "functions": [],
                          "resources": [
                            {
                              "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                              "apiVersion": "2021-02-01",
                              "name": "[format('{0}-to-{1}', parameters('VNetName'), parameters('RemoteVNetName'))]",
                              "properties": {
                                "allowForwardedTraffic": true,
                                "allowVirtualNetworkAccess": true,
                                "allowGatewayTransit": false,
                                "useRemoteGateways": false,
                                "remoteVirtualNetwork": {
                                  "id": "[parameters('RemoteVNetId')]"
                                }
                              }
                            }
                          ]
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "SecondaryToPrimaryPeering",
                      "resourceGroup": "[parameters('SecondaryNetworkResourceGroup')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "RemoteVNetId": {
                            "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('PrimaryNetworkResourceGroup')), 'Microsoft.Network/virtualNetworks', parameters('PrimaryVNetName'))]"
                          },
                          "RemoteVNetName": {
                            "value": "[parameters('PrimaryVNetName')]"
                          },
                          "VNetName": {
                            "value": "[parameters('SecondaryVNetName')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.613.9944",
                              "templateHash": "14916132073348539772"
                            }
                          },
                          "parameters": {
                            "VNetName": {
                              "type": "string"
                            },
                            "RemoteVNetName": {
                              "type": "string"
                            },
                            "RemoteVNetId": {
                              "type": "string"
                            }
                          },
                          "functions": [],
                          "resources": [
                            {
                              "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                              "apiVersion": "2021-02-01",
                              "name": "[format('{0}-to-{1}', parameters('VNetName'), parameters('RemoteVNetName'))]",
                              "properties": {
                                "allowForwardedTraffic": true,
                                "allowVirtualNetworkAccess": true,
                                "allowGatewayTransit": false,
                                "useRemoteGateways": false,
                                "remoteVirtualNetwork": {
                                  "id": "[parameters('RemoteVNetId')]"
                                }
                              }
                            }
                          ]
                        }
                      }
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', 'PrimaryRegion')]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', 'SecondaryRegion')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "OperationalMonitoring",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "AlertEmails": {
            "value": "[parameters('AlertEmails')]"
          },
          "Prefix": {
            "value": "[parameters('Prefix')]"
          },
          "PrimaryLocation": {
            "value": "[parameters('PrimaryLocation')]"
          },
          "PrimaryPrivateCloudName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'PrimaryRegion'), '2019-10-01').outputs.PrivateCloudName.value]"
          },
          "PrimaryPrivateCloudResourceId": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'PrimaryRegion'), '2019-10-01').outputs.PrivateCloudResourceId.value]"
          },
          "SecondaryPrivateCloudName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'SecondaryRegion'), '2019-10-01').outputs.PrivateCloudName.value]"
          },
          "SecondaryPrivateCloudResourceId": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'SecondaryRegion'), '2019-10-01').outputs.PrivateCloudResourceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "9573489242072614492"
            }
          },
          "parameters": {
            "Prefix": {
              "type": "string"
            },
            "PrimaryLocation": {
              "type": "string"
            },
            "AlertEmails": {
              "type": "array"
            },
            "PrimaryPrivateCloudName": {
              "type": "string"
            },
            "PrimaryPrivateCloudResourceId": {
              "type": "string"
            },
            "SecondaryPrivateCloudName": {
              "type": "string"
            },
            "SecondaryPrivateCloudResourceId": {
              "type": "string"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[format('{0}-Operational', parameters('Prefix'))]",
              "location": "[parameters('PrimaryLocation')]"
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "ActionGroup",
              "resourceGroup": "[format('{0}-Operational', parameters('Prefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Prefix": {
                    "value": "[parameters('Prefix')]"
                  },
                  "ActionGroupEmails": {
                    "value": "[parameters('AlertEmails')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "9751832110496562664"
                    }
                  },
                  "parameters": {
                    "Prefix": {
                      "type": "string"
                    },
                    "ActionGroupEmails": {
                      "type": "array",
                      "defaultValue": []
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "microsoft.insights/actionGroups",
                      "apiVersion": "2019-06-01",
                      "name": "[format('{0}-ActionGroup', parameters('Prefix'))]",
                      "location": "Global",
                      "properties": {
                        "copy": [
                          {
                            "name": "emailReceivers",
                            "count": "[length(parameters('ActionGroupEmails'))]",
                            "input": {
                              "emailAddress": "[parameters('ActionGroupEmails')[copyIndex('emailReceivers')]]",
                              "name": "[split(parameters('ActionGroupEmails')[copyIndex('emailReceivers')], '@')[0]]",
                              "useCommonAlertSchema": false
                            }
                          }
                        ],
                        "enabled": true,
                        "groupShortName": "[format('{0}-ActionGroup', parameters('Prefix'))]"
                      }
                    }
                  ],
                  "outputs": {
                    "ActionGroupResourceId": {
                      "type": "string",
                      "value": "[resourceId('microsoft.insights/actionGroups', format('{0}-ActionGroup', parameters('Prefix')))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-Operational', parameters('Prefix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "PrimaryMetricAlerts",
              "resourceGroup": "[format('{0}-Operational', parameters('Prefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "ActionGroupResourceId": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-Operational', parameters('Prefix'))), 'Microsoft.Resources/deployments', 'ActionGroup'), '2019-10-01').outputs.ActionGroupResourceId.value]"
                  },
                  "AlertPrefix": {
                    "value": "[parameters('PrimaryPrivateCloudName')]"
                  },
                  "PrivateCloudResourceId": {
                    "value": "[parameters('PrimaryPrivateCloudResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "12845428194493309474"
                    }
                  },
                  "parameters": {
                    "AlertPrefix": {
                      "type": "string"
                    },
                    "ActionGroupResourceId": {
                      "type": "string"
                    },
                    "PrivateCloudResourceId": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "variables": {
                    "Alerts": [
                      {
                        "Name": "CPU",
                        "Description": "CPU Usage per Cluster",
                        "Metric": "EffectiveCpuAverage",
                        "SplitDimension": "clustername",
                        "Threshold": 80,
                        "Severity": 2
                      },
                      {
                        "Name": "Memory",
                        "Description": "Memory Usage per Cluster",
                        "Metric": "UsageAverage",
                        "SplitDimension": "clustername",
                        "Threshold": 80,
                        "Severity": 2
                      },
                      {
                        "Name": "Storage",
                        "Description": "Storage Usage per Datastore",
                        "Metric": "DiskUsedPercentage",
                        "SplitDimension": "dsname",
                        "Threshold": 70,
                        "Severity": 2
                      },
                      {
                        "Name": "StorageCritical",
                        "Description": "Storage Usage per Datastore",
                        "Metric": "DiskUsedPercentage",
                        "SplitDimension": "dsname",
                        "Threshold": 75,
                        "Severity": 0
                      }
                    ]
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "MetricAlert",
                        "count": "[length(variables('Alerts'))]"
                      },
                      "type": "Microsoft.Insights/metricAlerts",
                      "apiVersion": "2018-03-01",
                      "name": "[format('{0}-{1}', parameters('AlertPrefix'), variables('Alerts')[copyIndex()].Name)]",
                      "location": "Global",
                      "properties": {
                        "description": "[variables('Alerts')[copyIndex()].Description]",
                        "criteria": {
                          "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
                          "allOf": [
                            {
                              "name": "Metric1",
                              "operator": "GreaterThan",
                              "threshold": "[variables('Alerts')[copyIndex()].Threshold]",
                              "timeAggregation": "Average",
                              "criterionType": "StaticThresholdCriterion",
                              "metricName": "[variables('Alerts')[copyIndex()].Metric]",
                              "dimensions": [
                                {
                                  "name": "[variables('Alerts')[copyIndex()].SplitDimension]",
                                  "operator": "Include",
                                  "values": [
                                    "*"
                                  ]
                                }
                              ]
                            }
                          ]
                        },
                        "scopes": [
                          "[parameters('PrivateCloudResourceId')]"
                        ],
                        "severity": "[variables('Alerts')[copyIndex()].Severity]",
                        "evaluationFrequency": "PT1M",
                        "windowSize": "PT5M",
                        "autoMitigate": true,
                        "enabled": true,
                        "actions": [
                          {
                            "actionGroupId": "[parameters('ActionGroupResourceId')]"
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-Operational', parameters('Prefix'))), 'Microsoft.Resources/deployments', 'ActionGroup')]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-Operational', parameters('Prefix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "SecondaryMetricAlerts",
              "resourceGroup": "[format('{0}-Operational', parameters('Prefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "ActionGroupResourceId": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-Operational', parameters('Prefix'))), 'Microsoft.Resources/deployments', 'ActionGroup'), '2019-10-01').outputs.ActionGroupResourceId.value]"
                  },
                  "AlertPrefix": {
                    "value": "[parameters('SecondaryPrivateCloudName')]"
                  },
                  "PrivateCloudResourceId": {
                    "value": "[parameters('SecondaryPrivateCloudResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "12845428194493309474"
                    }
                  },
                  "parameters": {
                    "AlertPrefix": {
                      "type": "string"
                    },
                    "ActionGroupResourceId": {
                      "type": "string"
                    },
                    "PrivateCloudResourceId": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "variables": {
                    "Alerts": [
                      {
                        "Name": "CPU",
                        "Description": "CPU Usage per Cluster",
                        "Metric": "EffectiveCpuAverage",
                        "SplitDimension": "clustername",
                        "Threshold": 80,
                        "Severity": 2
                      },
                      {
                        "Name": "Memory",
                        "Description": "Memory Usage per Cluster",
                        "Metric": "UsageAverage",
                        "SplitDimension": "clustername",
                        "Threshold": 80,
                        "Severity": 2
                      },
                      {
                        "Name": "Storage",
                        "Description": "Storage Usage per Datastore",
                        "Metric": "DiskUsedPercentage",
                        "SplitDimension": "dsname",
                        "Threshold": 70,
                        "Severity": 2
                      },
                      {
                        "Name": "StorageCritical",
                        "Description": "Storage Usage per Datastore",
                        "Metric": "DiskUsedPercentage",
                        "SplitDimension": "dsname",
                        "Threshold": 75,
                        "Severity": 0
                      }
                    ]
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "MetricAlert",
                        "count": "[length(variables('Alerts'))]"
                      },
                      "type": "Microsoft.Insights/metricAlerts",
                      "apiVersion": "2018-03-01",
                      "name": "[format('{0}-{1}', parameters('AlertPrefix'), variables('Alerts')[copyIndex()].Name)]",
                      "location": "Global",
                      "properties": {
                        "description": "[variables('Alerts')[copyIndex()].Description]",
                        "criteria": {
                          "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
                          "allOf": [
                            {
                              "name": "Metric1",
                              "operator": "GreaterThan",
                              "threshold": "[variables('Alerts')[copyIndex()].Threshold]",
                              "timeAggregation": "Average",
                              "criterionType": "StaticThresholdCriterion",
                              "metricName": "[variables('Alerts')[copyIndex()].Metric]",
                              "dimensions": [
                                {
                                  "name": "[variables('Alerts')[copyIndex()].SplitDimension]",
                                  "operator": "Include",
                                  "values": [
                                    "*"
                                  ]
                                }
                              ]
                            }
                          ]
                        },
                        "scopes": [
                          "[parameters('PrivateCloudResourceId')]"
                        ],
                        "severity": "[variables('Alerts')[copyIndex()].Severity]",
                        "evaluationFrequency": "PT1M",
                        "windowSize": "PT5M",
                        "autoMitigate": true,
                        "enabled": true,
                        "actions": [
                          {
                            "actionGroupId": "[parameters('ActionGroupResourceId')]"
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-Operational', parameters('Prefix'))), 'Microsoft.Resources/deployments', 'ActionGroup')]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-Operational', parameters('Prefix')))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', 'PrimaryRegion')]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', 'SecondaryRegion')]"
      ]
    }
  ]
}